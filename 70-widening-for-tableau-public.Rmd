---
title: "Widening for Tableau Public"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---



# Structure

Now that we finally have a single dataframe with all the countries with only the common questions, we need to widen it so that it fits within Tableau Public's limit.

In order to do this we are going to:

* combine columns into the format of "category:question text"
* select the necessary columns (country, wave, person_id, weight, category_question, answer_measure)
* pivot using names from `category_question` and values from `answer_measure`

## Combining category and question
```{r}
total_long_common_narrow <- total_long_common_recoded %>% 
  unite(category_question, category, question, sep = ":", remove = FALSE) %>%
  select(country, wave, person_id = person_id_factor, weights, category_question, question, column_name, answer_measure, answer_dimension) 
```

Clear out all but needed dataframes to reduce memory

```{r}
rm.all.but(c("total_long_common_recoded", "total_long_common", "total_long_common_narrow", "combined_clean", "label_val", "qword"))
```


## Pivoting Wider 

Adding in just a few of the categorical. 

```{r}
final_wide_measure <- total_long_common_narrow %>% 
  pivot_wider(id_cols = c(person_id, country, wave), 
              names_from = question,
              values_from = answer_measure)
#Replace this with lookup from labval
final_wide_factor <- total_long_common_narrow %>%
  filter(
    question %in% c(
      "Sexo",
      "Edad",
      "Estado civil",
      "Participó en una protesta",
      "Simpatiza con algún partido político",
      "	Votó en las últimas elecciones presidenciales"
    )
  ) %>%
  pivot_wider(id_cols = c(person_id, country, wave), 
              names_from = question,
              values_from = answer_dimension)

final_wide <- final_wide_factor %>%
  left_join(final_wide_measure, by = c("person_id", "country", "wave"), suffix = c("_l", "_n"))
  
  
#join

write_csv(final_wide, "lapop_wide_v3.csv") 
```


##Find specific questions
```{r}
q_explore <- total_long_common %>%
  select(question) %>%
  distinct()

total_long_common %>%
  filter(question %in% c("Sexo", "Estado civil", "Participó en una protesta", "Simpatiza con algún partido político", "Votó en las últimas elecciones presidenciales", "Solicitó ayuda a un miembro de la Asamblea Legistlativa"))

```


# Analyze wider version

Look at summary of each column
```{r}
summary(final_wide)
```

Try tabyl:

```{r}
final_wide %>%
  tabyl(`Crime, Insecurity, and Policy Preferences:Víctima de delincuencia en los últimos 12 meses`)
```

