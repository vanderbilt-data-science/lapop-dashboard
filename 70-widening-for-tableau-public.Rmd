---
title: "Widening for Tableau Public"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---



# Structure

Now that we finally have a single dataframe with all the countries with only the common questions, we need to widen it so that it fits within Tableau Public's limit.

In order to do this we are going to:

* combine columns into the format of "category:question text"
* select the necessary columns (country, wave, person_id, weight, category_question, answer_measure)
* pivot using names from `category_question` and values from `answer_measure`

## Combining category and question
```{r Combine category and question}
total_long_common_narrow <- total_long_common_recoded %>% 
  left_join(questions_cats, by = "column_name") %>%
  rename(category = category_short_es, question = question_short_es) %>% 
  unite(category_question, category, question, sep = ":", remove = FALSE) %>%
  unite(category_colname, category, column_name, sep = ":", remove = FALSE) %>%
  select(country, wave, person_id, weights, column_name, category_question, category_colname, question, column_name, answer_measure, answer_dimension) 
```

Clear out all but needed dataframes to reduce memory

```{r Remove useless df}
rm.all.but(c("total_long_common_recoded", "total_long_common", "total_long_common_narrow", "combined_clean", "response_labels"))
```


## Pivoting Wider 

Explicitly name the dimensions and measures 

Define list of all columns names that are measures
```{r Create measures/dimensions list}
measures <- c(
      "a4r",
      "aoj11",
      "aoj12",
      #"b0", Removed per Maita to Yilin on 4/21/2020
      "b1",
      "b12",
      "b13",
      "b18",
      "b2",
      "b21",
      "b21a",
      "b3",
      "b31",
      "b32",
      "b37",
      "b4",
      "b47a",
      "b6",
      "cct1b",
      "d1",
      "d2",
      "d3",
      "d4",
      "d5",
      "d6",
      "dst1b",
      "e5",
      "eff1",
      "eff2",
      "exc11",
      "exc13",
      "exc14",
      "exc15",
      "exc16",
      "exc18",
      "exc2",
      "exc6",
      "exc7",
      "formal",
      "ing4",
      "it1",
      "jc10",
      "jc13",
      "jc15a",
      "jc16a",
      "m1",
      "mil10a",
      "mil10e",
      "pn4",
      "pol1",
      "pra8n",
      "prot3",
      "q2",
      "q10a",
      "q5b",
      "r1",
      "r12",
      "r14",
      "r15",
      "r16",
      "r18",
      "r3",
      "r4",
      "r4a",
      "redist1",
      "redist2a",
      "redist3",
      "ros4",
      "smedia1",
      "smedia4",
      "smedia7",
      "vb10",
      "vb2",
      "vb50",
      "vb58",
      "vic1ext",
      "w14a",
      "wf1"
    )

dimensions <- c(
      "a4r",
      "colorr",
      "conocim",
      "cp13",
      "cp6",
      "cp7",
      "cp8",
      "drk1",
      "ed",
      "env1calt",
      "env2b",
      "estratosec",
      "exc7new",
      "gi0n",
      "idio2",
      "idiomaq",
      "infrax",
      "inteval",
      "l1",
      "ocup1a",
      "ocup4a",
      "ocupoit",
      "pais",
      "pra10",
      "pra2n",
      "pra8an_1",
      "pra8an_2",
      "pra8an_3",
      "pra8an_5",
      "pra8an_6",
      "pra8an_7",
      "pra8an_77",
      "psc1",
      "psc10",
      "psc11",
      "psc11a",
      "psc12",
      "psc13_1",
      "psc13_10",
      "psc13_11",
      "psc13_12",
      "psc13_13",
      "psc13_2",
      "psc13_3",
      "psc13_4",
      "psc13_5",
      "psc13_6",
      "psc13_7",
      "psc13_8",
      "psc13_9",
      "psc2",
      "psc3_0",
      "psc3_1",
      "psc3_2",
      "psc3_3",
      "psc4",
      "psc5",
      "psc6",
      "psc7",
      "psc8",
      "psc9",
      "q1",
      "q10e",
      "q11n",
      "q12bn",
      "q12c",
      "q14",
      "q2",
      "q3cn",
      "q5a",
      "r5",
      "r6",
      "r7",
      "r8",
      "smedia2",
      "smedia3",
      "smedia5",
      "smedia6",
      "smedia8",
      "smedia9",
      "soct2",
      "ur",
      "vb20",
      "vb51",
      "vb52",
      "year"
    )
```


```{r Save wide data as .csv}
final_wide_measure <-
  total_long_common_narrow %>% # Include only measures (cols with recode)
  filter(
    column_name %in% measures
  ) %>%
  pivot_wider(
    id_cols = c(person_id, country, wave),
    names_from = column_name,
    values_from = answer_measure
  )
# Put _m or m_ in names here to simplify measure/dimension designation

final_wide_dimension <-
  total_long_common_narrow %>% # Include only dimensions (cols with label or no recode )
  filter(
    column_name %in% dimensions
  ) %>%
  pivot_wider(
    id_cols = c(person_id, country, wave),
    names_from = column_name,
    values_from = answer_dimension
  )

final_wide <- final_wide_dimension %>%
  left_join(final_wide_measure, by = c("person_id", "country", "wave"), suffix = c("_d", "_m"))
  
  
#join

# Update the version of the csv to reflect code cleanup
#Updating to version 6 to reflect the work on updating the lookup tables

write_csv(final_wide, "lapop_wide_v6.csv", na = "NULL ") 
```


##Find specific questions
```{r Check specific question}
total_long_common_narrow %>% 
  filter(column_name == "a4r")

```


