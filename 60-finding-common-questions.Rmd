---
title: "Finding Common Questions"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Structure
In order to cut down on the size of the data, we are reducing the total combination of all countries to the common questions.

```{r, message=FALSE}
library(janitor)
library(rlang)
```


## NOTE: SEE ISSUE #35

LAPOP has defined which questions to inlcude. Rather than determining which questions appear across all country questionnaires, we'll do a lookup using 

QWORD_2018_Core_10plus_countries(v1.0).csv
LAB_VAL_2018_Core_10plus_countries(v1.0).csv

QWORD_2018_Core_10plus_countries(v1.0).csv
LAB_VAL_2018_Core_10plus_countries(v1.0).csv

contain a listing of all of the questions (QWORD) and values (LAB_VAL) for all survey questions that appeared in 10 or more countries in the 2018 wave. 

We will use this data to:
1. Define the common questions that are to appear in the dashboards (Issue #37)
2. Rescale the values for each of the responses to be between 0 and 100 (Issue #32)
3. Group by age group (Issue #29)

We will read in the data here, and address 1-3 elsewhere in the code (follow the commits closing each issue to identify where these tables are used)

## Read in reference tables

```{r}
label_val <-
  read_csv(
    "LAB_VAL_2018_Core_10plus_countries(v1.0).csv",
    col_types = cols(recoded = col_character(),
                     value = col_character()),
    locale = locale(encoding = "ISO-8859-1")
  ) %>%
  clean_names()
qword <- read_csv("QWORD_2018_Core_10plus_countries(v1.0).csv", 
    locale = locale(encoding = "ISO-8859-1")) %>%
  clean_names()
```

Using the lookup tables above, filter out the questions that are not in the list

Use qword, then get unique of question, feed to find_common.



```{r}
#Common questions as defined by LAPOP 
common_questions <- qword %>%
  select(column_name = name, question = qword_esp) %>%
  distinct()

#Creating a list with all the clean data frames
countries <- list(argentina_clean, belize_clean, bolivia_clean, brazil_clean, canada_clean, chile_clean, costa_clean, ecuador_clean, elsalvador_clean, guatemala_clean, guyana_clean, honduras_clean, jamaica_clean, mexico_clean, nicaragua_clean, panama_clean, paraguay_clean, peru_clean, suriname_clean, uruguay_clean, usa_clean, venezuela_clean) #colombia_clean not resolved

#Function for joining dataframes to ensure each country has only the common questions
find_common <- function(country_dfr, questions_dfr) {
  semi_join(country_dfr, questions_dfr, by = "column_name")
}

#Applying `map_dfr` to create combined dataframe
#countries_common_only <- map_dfr(countries, find_common, common_questions)

#Trying `map_dfr` on combined_clean
total_long_common <- find_common(combined_clean, common_questions) 

```

*NOTE*

There are 96 questions that came across. See which ones were dropped from list. Issue

Testing
```{r}
argentina_clean %>%
  semi_join(common_questions, by = "column_name") %>%
  tabyl(question)
```

## Testing

How many questions?
```{r}
total_long_common %>%
  tabyl(question) 

total_long_common %>%
  count(question)
```

Joining is not working. Might need to persist question code, but check on join first. 













## THE FOLLOWING IS DEPRECATED

Remove the following once the new approach is validated.

## Alternate approach
We need country, wave, and questions to create a new data frame with `unique()`. Then we need to create a function that gets - `select()` - these columns, makes them unique, creates a new column with its count - `summarize(n())` - and finally filters down to the ones that occur in all datasets - `filter(x == total # of countries)`.

*Current total number of countries is 23* Note, there is an issue with Colombia, so belueve I use n == 22.

I am first going to test on Argentina and Bolivia.
*Jesse, this is not necessary for you to run*
### Collecting all questions
```{r}
# argentina_narrow <- argentina_clean %>% 
#   #Narrows data frame to two variables
#   select(country, question) %>% 
#   mutate(country = as.character(country)) %>% 
#   #Returns each question once
#   unique()
# 
# #Repeating the process
# bolivia_narrow <- bolivia_clean %>% 
#   #Narrows data frame to two variables
#   select(country, question) %>% 
#   mutate(country = as.character(country)) %>% 
#   #Returns each question once
#   unique()

#test1 <- bind_rows(argentina_narrow, bolivia_narrow)
#str(argentina_narrow)
```

## Creating single dataframe with all countries and common questions
```{r}
# #Making a function that can be iterated multiple times
# select_questions <- function(country_df){
#   country_df %>% 
#     select(country, question) %>% 
#     mutate(country = as.character(country)) %>% 
#     unique()
# }
# 
# #test <- select_questions(belize_clean)
# 
# #Creating a list with all the clean data frames
# countries <- list(argentina_clean, belize_clean, bolivia_clean, brazil_clean, canada_clean, chile_clean, costa_clean, ecuador_clean, elsalvador_clean, guatemala_clean, guyana_clean, honduras_clean, jamaica_clean, mexico_clean, nicaragua_clean, panama_clean, paraguay_clean, peru_clean, suriname_clean, uruguay_clean, usa_clean, venezuela_clean) #colombia_clean not resolved
# 
# #length(countries) There are 22 countries, excluding colombia_clean
# 
# #Narrowing countries to just have two columns and combining into one data frame
# combined_questions <- map_dfr(countries, select_questions)
# #length(combined_questions)


```


```{r}
# #Checking to make sure no countries were repeated
# combined_questions %>% 
#   select(country) %>% 
#   unique()
# 
# #Checking structure of object `question_frequency`
# #str(question_frequency)
# 
# #Isolating common questions
# common_questions <- question_frequency %>% 
#   select(n, question) %>% 
#   #Change this back to 23
#   filter(n == 22) %>% 
#   select(question)
# 
# #str(common_questions)
# 
# #Testing to see if semi_join works
# #semi_join(argentina_clean, common_questions, by = "question")
# 
# 
# #Trying `map_dfr` on combined_clean
# total_long_common <- find_common(combined_clean, common_questions) 
# # assert(total_long_common, is_uniq, person_id_factor)
# 
# # The number of cases in total_long_common matches countries_common_only, so it has only common questions. 
```

## !DO NOT USE REFERENCE ONLY

### Filter common questions



## Exploring Issue #21

```{r}
# #Frequency table for total number of questions
# question_frequency <- combined_questions %>% 
#   tabyl(question)
```

In which countries does Urbano/Rural NOT appear?
```{r}
# combined_questions %>% 
#   filter()

```

