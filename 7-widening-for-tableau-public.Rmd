---
title: "Widening for Tableau Public"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Structure

Now that we finally have a single dataframe with all the countries with only the common questions, we need to widen it so that it fits within Tableau Public's limit.

In order to do this we are going to:

* combine columns into the format of "category:question text"
* select the necessary columns (country, wave, person_id, weight, category_question, answer_measure)
* pivot using names from `category_question` and values from `answer_measure`

## Combining category and question
```{r}
total_long_common <- total_long_common %>% 
  unite(category_question, category, question, sep = ":")
```

## Pivoting Wider (!Runs error because answer_measure not uniquely identified)
Also, this is where my memory fails
```{r}
final_wide <- total_long_common %>% 
  select(country, wave, person_id, weights, category_question, answer_measure) %>% 
  pivot_wider(id_cols = person_id,
              names_from = category_question,
              values_from = answer_measure)

final_wide
```



*Jesse, not sure if the code below is useful at all, but I will leave it uncommented*
## Combining category and question
```{r}
countries_common_only <- countries_common_only %>% 
  unite(category_question, category, question, sep = ":")
```

## Pivoting Wider (!Runs error because answer_measure not uniquely identified)
```{r}
countries_common_only <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  pivot_wider(id_cols = person_id, names_from = category_question, values_from = answer_measure)
```

Ran into error saying that values are not uniquely identified. Going to try to identify duplicates. 
Check "Testing Wide Unique ID.Rmd" for results
```{r}
test0 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

```{r}
test0 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country ==  "Guyana") %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

## Pivoting countries that have confirmed unique IDs
```{r}
wide_confirmed_countries <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil", "Chile", "Guyana", "Nicaragua", "Panama", "Paraguay", "Peru", "Suriname", "United States", "Uruguay", "Venezuela")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)

wide_confirmed_countries
```

Above thew an error that "longer object length is not a multiple of shorter length" so I'm going to try to find where that is.

## Testing different combinations of countries
```{r}
combo_1 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_1 #Throws length error but produces some values
```

```{r}
combo_2 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_2 #No error thrown but more missing values
```

```{r}
combo_3 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil", "Chile")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_3 #Throws length error but produces a lot more values
```
```{r}
argentina_wide <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == "Argentina") %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
argentina_wide
```

Going to try adding in a row number
```{r}
test1 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  mutate(row_num = row_number()) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

Error occurs again here going to look into other arguments in `pivot_wider()`
```{r}
test2 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, names_repair = "unique", values_from = answer_measure)
```

## Pivoting individual countries to then later combine
Here is a character vector with the countries that currently have unique IDs. Still said that same error that longer object length is not a multiple of shorter object length, but will come back to this.
```{r}
current_countries <- countries_common_only %>% 
  filter(country == c("Argentina", "Belize", "Brazil", "Chile", "Guyana", "Nicaragua", "Panama", "Paraguay", "Peru", "Suriname", "United States", "Uruguay", "Venezuela"))
```

### Function to pivot each country
```{r}
widen_unique_countries <- function(country_df, country_name){
  country_df %>% 
    select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
    filter(country == country_name) %>% 
    pivot_wider(names_from = category_question, values_from = answer_measure)
}
```

```{r}
argentina_uniq <- widen_unique_countries(countries_common_only, "Argentina")
belize_uniq <- widen_unique_countries(countries_common_only, "Belice")
brazil_uniq <- widen_unique_countries(countries_common_only, "Brazil")
chile_uniq <- widen_unique_countries(countries_common_only, "Chile")
guyana_uniq <- widen_unique_countries(countries_common_only, "Guyana")
#nicaragua_uniq <- widen_unique_countries(countries_common_only, "Nicaragua")
panama_uniq <- widen_unique_countries(countries_common_only, "Panama")
paraguay_uniq <- widen_unique_countries(countries_common_only, "Paraguay")
peru_uniq <- widen_unique_countries(countries_common_only, "Peru")
suriname_uniq <- widen_unique_countries(countries_common_only, "Suriname")
usa_uniq <- widen_unique_countries(countries_common_only, "United States")
uruguay_uniq <- widen_unique_countries(countries_common_only, "Uruguay")
venezuela_uniq <- widen_unique_countries(countries_common_only, "Venezuela")

first_combined <- rbind(arg_uniq, bel_uniq) #This works

separate_wide_countries <- list(argentina_uniq, belize_uniq, brazil_uniq, chile_uniq, guyana_uniq, panama_uniq, paraguay_uniq, peru_uniq, suriname_uniq, usa_uniq, uruguay_uniq, venezuela_uniq)
```

```{r}
widened_unique_countries <- rbind(argentina_uniq, belize_uniq, brazil_uniq, chile_uniq, guyana_uniq, panama_uniq, paraguay_uniq, peru_uniq, suriname_uniq, usa_uniq, uruguay_uniq, venezuela_uniq)
```






