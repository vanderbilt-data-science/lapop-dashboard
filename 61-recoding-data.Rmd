---
title: "61-recoding-data"
output: html_notebook
---

# Recoding Data

In this section we'll rescale data according to the calculations by LAPOP (Issue #32) and add age grouping (Issue #29). Any additional recoding from the raw data should be included here as well. 

Note that weights will be calculated on the fly within the Tableau dashboard as needed.



## Joining data

We'll start by joining to the tables imported from 

LAB_VAL_2018_Core_10plus_countries(v1.0).csv

in 60. 


NOTE: We are looking up the values instead of directly calculating because some are recoded, other are not. Some have highest mapped to 0, others have lowest. 

```{r join-recodes}

# We'll need to join on both the question name and on the response to get the proper scaled score. 

#Create a dataframe with question AND response labels

response_labels <- label_val %>%
  rename(column_name = lname) %>% 
  left_join(qword, by = c("column_name" = "name")) %>%
  select(column_name, question_es = qword_esp, value, recoded, label_esp) 

# # check to make sure join will work
# total_long_common %>%
#   mutate(answer_measure = as.character(answer_measure)) %>%
#   anti_join(response_labels, 
#             by = c("column_name" = "column_name", "answer_measure" = "value"))

## Use recoded values only for answer_measure. If there is no recoding, it's not a measure 
## See Issue 52
## Replace in all cases if answer_dimension 
total_long_common_recoded <- total_long_common %>%
  mutate(answer_measure = as.character(answer_measure)) %>%
  left_join(response_labels, 
            by = c("column_name" = "column_name", "answer_measure" = "value")) %>%
  mutate(answer_measure = recoded,
         answer_dimension = label_esp)
```


## Add agegroup

Data is now in long format, so we need to recode within a answer_measure IF question_es is q2 Edad

```{r}
total_long_common %>%
  mutate(answer_dimension = if_else(column_name == "q2", 
                                  as.character(cut(answer_measure, 
                                      breaks = c(0, 25, 35, 45, 55, 65, 66), 
                                      labels = c("18-25", "26-35", "36-45", "46-55", "56-65", "66-"))),
                                  answer_dimension)) %>%
  filter(column_name == "q2") %>%
  select(answer_measure, answer_dimension, everything()) 
           
  
```




## Examine q1
```{r}
total_long_common_recoded %>%
  filter(column_name == "q1") %>%
  select(answer_measure, answer_dimension) %>% 
  distinct()
  
  tabyl(answer_measure)
```


